---
phase: 03-design-to-code
plan: 02
type: execute
---

<objective>
Create the visual properties knowledge module — encoding the production plugin's rules for extracting and generating CSS from Figma fills, strokes, effects, corner radii, gradients, opacity, and blend modes.

Purpose: Enable Claude to accurately convert any Figma visual property into its CSS equivalent, including complex cases like gradient angle conversion, per-side strokes, multiple fills, and variable-bound colors.
Output: `knowledge/design-to-code-visual.md`
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/3-design-to-code/03-01-SUMMARY.md

# Figma API references:
@knowledge/figma-api-rest.md
@knowledge/figma-api-variables.md

# Sibling module for layout context:
@knowledge/design-to-code-layout.md

# Source material — the production plugin's extraction + generation:
# READ THESE FILES to extract the actual visual mapping rules:
# (reference plugin) src/extraction/visual.ts
# (reference plugin) src/generation/visual.ts
# (reference plugin) src/types/extracted.ts (FillData, StrokeData, EffectData, CornerRadius)
# (reference plugin) src/tokens/colors.ts
# (reference plugin) src/tokens/effects.ts

# Archive specs:
@archive/agent-rewritten-01.md
@archive/initial-agent-audit.md

# Module conventions:
@knowledge/README.md

**Established patterns:** ~700-900 line knowledge modules, TypeScript interfaces where helpful
**Constraining decisions:**
- Phase 1: Module structure convention
- Phase 2: Node visual properties documented in figma-api-rest.md
- Phase 2: Variable bindings for colors documented in figma-api-variables.md
- Variable binding: paint-level AND node-level bindings with fallback (from the production plugin)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Read production plugin visual source files</name>
  <files>
    (reference plugin) src/extraction/visual.ts,
    (reference plugin) src/generation/visual.ts,
    (reference plugin) src/types/extracted.ts,
    (reference plugin) src/tokens/colors.ts,
    (reference plugin) src/tokens/effects.ts
  </files>
  <action>
Read ALL listed source files from the production plugin to understand the complete visual property extraction and generation pipeline. Take notes on:

1. **Fill extraction** (visual.ts extraction):
   - SOLID fills: RGB → hex conversion formula, opacity handling
   - GRADIENT fills: LINEAR, RADIAL, ANGULAR, DIAMOND types
   - IMAGE fills: scaleMode (FIT/COVER), imageRef handling
   - Multiple fills: ordering (Figma bottom-to-top vs CSS top-to-bottom)
   - Variable bindings: paint-level `boundVariables.color.id` AND node-level `boundVariables.fills[index].id`
   - Visibility: `visible !== false` filtering

2. **Gradient angle conversion** (generation):
   - Figma transform matrix → CSS gradient angle
   - The math: `Math.atan2(handlePositions)` → degrees conversion
   - Linear: `linear-gradient(Xdeg, ...stops)`
   - Radial: `radial-gradient(circle, ...stops)`
   - Angular/Conic: `conic-gradient(...)`

3. **Stroke extraction and generation**:
   - Color, weight, alignment (INSIDE/OUTSIDE/CENTER)
   - Per-side stroke weights (different top/right/bottom/left)
   - Dash pattern
   - CSS mapping: INSIDE → `box-shadow: inset`, CENTER → `border`, OUTSIDE → `box-shadow` or `outline`

4. **Effects extraction and generation**:
   - DROP_SHADOW → `box-shadow: X Y blur spread color`
   - INNER_SHADOW → `box-shadow: inset X Y blur spread color`
   - LAYER_BLUR → `filter: blur(Xpx)`
   - BACKGROUND_BLUR → `backdrop-filter: blur(Xpx)`
   - Multiple effects stacking

5. **Corner radius**:
   - Uniform: single `border-radius`
   - Per-corner: `border-radius: TL TR BR BL`
   - Detection of mixed vs uniform
   - Variable bindings for radii

6. **Opacity and blend modes**:
   - Node-level opacity → CSS `opacity`
   - Fill-level opacity → rgba alpha channel
   - Blend modes → CSS `mix-blend-mode`

7. **Color token integration** (colors.ts):
   - Hex normalization for consistent lookup
   - Semantic color naming (HSL analysis → primary/secondary/accent)
   - Variable binding → `var(--color-name)` with fallback

Do NOT create any files yet. This is a read-only research task.
  </action>
  <verify>All source files read and visual property mapping rules understood. No files created.</verify>
  <done>Complete understanding of the production plugin's visual property extraction → generation pipeline, ready to encode into knowledge module.</done>
</task>

<task type="auto">
  <name>Task 2: Create design-to-code-visual.md knowledge module</name>
  <files>knowledge/design-to-code-visual.md</files>
  <action>
Create the authoritative visual properties knowledge module using patterns extracted from the production plugin's code.

**Must cover (organized into clear sections):**

1. **Fills → CSS Background**
   - SOLID: `{ r, g, b }` + opacity → `#RRGGBB` or `rgba(R, G, B, A)`
   - RGB to hex formula: `Math.round(channel * 255).toString(16).padStart(2, '0')`
   - Multiple fills: Figma renders bottom-to-top, CSS renders top-to-bottom — REVERSE the array
   - Visibility filtering: skip fills where `visible === false`
   - Image fills: `url()` with `background-size: contain` (FIT) or `cover` (COVER)

2. **Gradient Mapping**
   - LINEAR: Figma gradient handles → CSS angle + color stops
   - Angle conversion from Figma's 2D transform matrix (document the math)
   - RADIAL: `radial-gradient(circle, ...stops)` — note Figma uses ellipse by default
   - ANGULAR: `conic-gradient(from Xdeg, ...stops)`
   - DIAMOND: no direct CSS equivalent — approximate with radial
   - Color stop positioning: `{ position: 0.5, color: '#ff0000' }` → `#ff0000 50%`
   - Gradient text: `background-clip: text; -webkit-background-clip: text; color: transparent`

3. **Strokes → CSS Border/Shadow**
   - Stroke alignment mapping:
     - CENTER → `border: Wpx solid color` (default CSS behavior)
     - INSIDE → Use `box-shadow: inset 0 0 0 Wpx color` (border adds to dimensions, shadow doesn't)
     - OUTSIDE → Use `box-shadow: 0 0 0 Wpx color` (or `outline: Wpx solid color`)
   - Per-side stroke weights: different top/right/bottom/left → separate `border-top`, `border-right`, etc.
   - Dash pattern: `strokeDashPattern: [dash, gap]` → `border-style: dashed`
   - Stroke cap and join: `strokeCap`, `strokeJoin` → SVG attributes (not CSS-applicable)

4. **Effects → CSS Shadows & Filters**
   - DROP_SHADOW: `{ offset: {x, y}, radius, spread, color }` → `box-shadow: Xpx Ypx Rpx Spx color`
   - INNER_SHADOW: Same but → `box-shadow: inset Xpx Ypx Rpx Spx color`
   - LAYER_BLUR: `{ radius }` → `filter: blur(Rpx)`
   - BACKGROUND_BLUR: `{ radius }` → `backdrop-filter: blur(Rpx)` (needs `-webkit-` prefix check)
   - Multiple effects: combine in single property (comma-separated for box-shadow, space-separated for filter)
   - Effect visibility: skip effects where `visible === false`

5. **Corner Radius**
   - Uniform: `cornerRadius: N` → `border-radius: Npx`
   - Per-corner: `cornerRadius: [TL, TR, BR, BL]` or individual `topLeftRadius`, `topRightRadius`, etc.
   - Detection: if all four corners equal → use shorthand; otherwise use `border-radius: TL TR BR BL`
   - Variable bindings: `boundVariables.cornerRadius` → `var(--radius-name)`
   - Percentage radii for circles: `border-radius: 50%` when radius ≥ min(width, height) / 2

6. **Opacity & Blend Modes**
   - Node-level opacity: `opacity: 0.5` → CSS `opacity: 0.5`
   - Fill-level opacity: included in rgba alpha channel (NOT a separate CSS property)
   - Interaction: node opacity × fill opacity = visual opacity
   - Blend modes mapping: `blendMode: MULTIPLY` → `mix-blend-mode: multiply` (most map directly, some Figma-specific)
   - Common blend modes: NORMAL, MULTIPLY, SCREEN, OVERLAY, DARKEN, LIGHTEN, COLOR_DODGE, COLOR_BURN, HARD_LIGHT, SOFT_LIGHT, DIFFERENCE, EXCLUSION, HUE, SATURATION, COLOR, LUMINOSITY

7. **Variable Binding for Visual Properties**
   - Paint-level binding: `paint.boundVariables.color.id` → lookup variable → `var(--color-name)`
   - Node-level binding: `node.boundVariables.fills[0].id` → same resolution
   - Fallback strategy: if variable exists → use var(), otherwise → use raw hex/rgba
   - Stroke variables, effect color variables, radius variables — same pattern
   - Always include raw value as fallback: `var(--color-primary, #1a1a1a)`

8. **Common Pitfalls**
   - Figma's RGB channels are 0-1 float, NOT 0-255 — must multiply by 255
   - Multiple fills are layered bottom-to-top in Figma but top-to-bottom in CSS
   - INSIDE strokes don't change element dimensions (use box-shadow, not border)
   - `cornerRadius` can be undefined (no rounding) vs 0 (explicit no rounding) — treat both as no radius
   - Gradient angle 0° in Figma may not mean 0° in CSS — verify transform matrix
   - Node opacity compounds with fill opacity (don't double-apply)

**Format:** Follow module structure convention. Include mapping tables, conversion formulas, and CSS generation examples. Use TypeScript interfaces for extracted visual types.

**Do NOT:** Fabricate Figma properties. Document only patterns verified against the production plugin's actual code.
  </action>
  <verify>
    - File exists at knowledge/design-to-code-visual.md
    - Contains all 5 sections (title, purpose, when-to-use, content, cross-references)
    - Documents fill types (solid, gradient, image) with CSS mapping
    - Covers gradient angle conversion (the math)
    - Covers stroke alignment mapping (INSIDE/CENTER/OUTSIDE → CSS)
    - Covers all 4 effect types with CSS equivalents
    - Documents corner radius (uniform vs per-corner)
    - Documents variable binding patterns
    - Cross-references figma-api-rest.md, figma-api-variables.md, design-to-code-layout.md
    - No real API keys or secrets
  </verify>
  <done>design-to-code-visual.md exists with complete visual property reference covering fills, gradients, strokes, effects, corner radius, opacity, blend modes, and variable bindings. All patterns verified against the production plugin's code.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] knowledge/design-to-code-visual.md exists
- [ ] Follows module structure convention
- [ ] All visual property mapping tables complete and accurate
- [ ] Gradient angle conversion documented with math
- [ ] Stroke alignment → CSS mapping correct (INSIDE → box-shadow inset, not border)
- [ ] All 4 effect types mapped to CSS
- [ ] Variable binding patterns documented
- [ ] Cross-references to API modules and layout module included
- [ ] No secrets, no fabricated properties
</verification>

<success_criteria>

- Visual properties knowledge module created and follows conventions
- All fill, stroke, effect, corner, opacity, blend mode mappings extracted from the production plugin
- Gradient conversion math documented
- Variable binding strategy documented
- Content optimized for Claude Code @reference consumption
</success_criteria>

<output>
After completion, create `.planning/phases/3-design-to-code/03-02-SUMMARY.md`
</output>
