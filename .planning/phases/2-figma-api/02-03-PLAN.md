---
phase: 2-figma-api
plan: 03
type: execute
---

<objective>
Create the Webhooks v2 knowledge module and perform final cross-module verification to ensure all 5 Figma API knowledge modules are consistent and accurate.

Purpose: Complete the Figma API knowledge base with webhooks documentation and verify the full module set is cross-referenced, consistent, and ready for downstream phases.
Output: `knowledge/figma-api-webhooks.md` + verified consistency across all 5 modules
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/2-figma-api/02-01-SUMMARY.md
@.planning/phases/2-figma-api/02-02-SUMMARY.md
@knowledge/README.md

# Source material:
@archive/agent-rewritten-01.md
@archive/initial-agent-audit.md

# Read all existing Phase 2 modules for cross-verification:
@knowledge/figma-api-rest.md
@knowledge/figma-api-variables.md
@knowledge/figma-api-plugin.md
@knowledge/figma-api-devmode.md

# Verify against current Figma developer documentation:
# - https://developers.figma.com/docs/rest-api/webhooks-endpoints/
# - https://developers.figma.com/docs/rest-api/webhooks/

**Key corrections from audit:**
- Webhook creation uses `context` + `context_id` (team/project/file), NOT deprecated `team_id`
- PING event on creation must be acknowledged
- Figma retries with exponential backoff — document this
- Respond with 200 OK quickly (avoid timeout)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create figma-api-webhooks.md — Webhooks v2 reference</name>
  <files>knowledge/figma-api-webhooks.md</files>
  <action>
Create the authoritative Figma Webhooks v2 reference module.

**Must cover:**
1. Webhooks v2 overview:
   - What webhooks are for (reacting to Figma file changes)
   - v2 format (NOT the deprecated v1 format with team_id)
   - Scoping: team, project, or file level via `context` + `context_id`
2. Webhook endpoints:
   - `POST /v2/webhooks` — create webhook
     - Required fields: event_type, context ("team"|"project"|"file"), context_id, endpoint, passcode
     - Response includes webhook id and status
   - `GET /v2/webhooks/:webhook_id` — get webhook details
   - `PUT /v2/webhooks/:webhook_id` — update webhook
   - `DELETE /v2/webhooks/:webhook_id` — delete webhook
   - `GET /v2/webhooks/teams/:team_id` — list team webhooks
3. Event types:
   - FILE_UPDATE — file saved/modified
   - FILE_DELETE — file deleted
   - FILE_VERSION_UPDATE — new version created
   - LIBRARY_PUBLISH — library component/style published
   - FILE_COMMENT — comment added to file
   - Document each event's payload structure
4. Webhook payload:
   - Common fields: event_type, passcode, timestamp, webhook_id
   - Event-specific fields (file_key, file_name, etc.)
   - PING event: sent on creation, must acknowledge with 200 OK
5. Operational considerations:
   - Passcode verification: compare webhook passcode to stored secret for request validation
   - Response requirements: return 200 OK quickly (< 30s), process asynchronously
   - Retry behavior: Figma uses exponential backoff on failure
   - Idempotency: same event may be delivered multiple times — handle gracefully
   - Webhook health: Figma disables webhooks after repeated failures
6. Practical patterns:
   - Setting up a webhook listener (Express/Next.js API route)
   - Verifying webhook authenticity via passcode
   - Processing FILE_UPDATE for design-to-code sync
   - Processing LIBRARY_PUBLISH for token sync
   - Error handling and logging best practices

**Format:** Follow module structure convention. Include practical server-side examples with TypeScript/Express. Show webhook creation curl examples.

**CRITICAL:** Use `context` + `context_id` format, NOT deprecated `team_id`. The audit explicitly flagged this.
  </action>
  <verify>
    - File exists at knowledge/figma-api-webhooks.md
    - Contains all 5 sections (title, purpose, when-to-use, content, cross-references)
    - Uses context + context_id NOT team_id (audit correction)
    - Documents PING event and acknowledgment requirement
    - Covers retry behavior and operational considerations
    - Includes practical webhook listener patterns
    - No real API keys, secrets, or passcodes
    - Cross-references figma-api-rest.md
  </verify>
  <done>figma-api-webhooks.md exists with complete Webhooks v2 reference covering endpoints, event types, payload format, operational considerations, and practical patterns. All audit corrections applied (context/context_id, PING handling).</done>
</task>

<task type="auto">
  <name>Task 2: Cross-module verification and consistency check</name>
  <files>knowledge/figma-api-rest.md, knowledge/figma-api-variables.md, knowledge/figma-api-plugin.md, knowledge/figma-api-devmode.md, knowledge/figma-api-webhooks.md, CLAUDE.md</files>
  <action>
Read all 5 knowledge modules and verify consistency. Fix any issues found.

**Verification checklist:**
1. Cross-references: Every module's "Cross-References" section must reference all related Phase 2 modules accurately
2. Naming consistency: All modules use the same terminology for shared concepts (node IDs, file keys, authentication, etc.)
3. No contradictions: If REST module says something about an endpoint, Plugin module shouldn't contradict it
4. Audit corrections applied everywhere:
   - Published components/styles endpoints clarified (REST module)
   - Correct image export endpoint (REST module)
   - Correct codegen manifest (DevMode module)
   - Correct Dev Resources POST body (DevMode module)
   - Correct webhook format (Webhooks module)
   - Enterprise access requirement (Variables module)
5. Module structure: All 5 modules follow title → purpose → when-to-use → content → cross-references

**Then update CLAUDE.md:**
- Remove "(coming)" from the 5 Figma API module entries in the knowledge modules table
- Keep "(coming)" on all other modules that haven't been created yet

**Do NOT:** Remove or modify any modules. Only fix cross-reference inconsistencies and update CLAUDE.md status markers.
  </action>
  <verify>
    - All 5 modules have consistent cross-references
    - No terminology contradictions between modules
    - All 6 audit corrections verified as applied
    - CLAUDE.md updated: 5 Figma API modules no longer show "(coming)"
    - All other modules still show "(coming)"
  </verify>
  <done>All 5 Figma API knowledge modules are cross-referenced consistently. CLAUDE.md updated to reflect completed modules. No contradictions or inaccuracies remain. Phase 2 complete.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] figma-api-webhooks.md exists and follows conventions
- [ ] All 5 modules cross-reference each other correctly
- [ ] No terminology or factual contradictions between modules
- [ ] All audit corrections verified across all modules
- [ ] CLAUDE.md updated (5 Figma API modules no longer "(coming)")
- [ ] No real secrets or API keys in any file
</verification>

<success_criteria>

- All 5 Figma API knowledge modules complete and consistent
- Webhooks v2 reference is accurate (context/context_id, PING, retries)
- Cross-module verification passes with no contradictions
- CLAUDE.md reflects completed Phase 2 modules
- Phase 2: Figma API Knowledge Module — complete
</success_criteria>

<output>
After completion, create `.planning/phases/2-figma-api/02-03-SUMMARY.md`

This is the final plan for Phase 2. The summary should include:
- All 5 modules created and their key content
- Audit corrections applied
- Cross-reference verification results
- Phase 2 complete status
- Readiness for Phase 3 (Design-to-Code) and Phase 4 (CSS/Tokens)
</output>
