---
phase: 2-figma-api
plan: 01
type: execute
---

<objective>
Create the REST API and Variables API knowledge modules — the two most foundational Figma API references that all other modules and skills depend on.

Purpose: Establish the authoritative REST API reference (endpoints, auth, pagination, rate limits, node structure) and the Variables API reference (collections, modes, bound variables, resolving) that Phase 3 (design-to-code), Phase 4 (tokens), and Phase 7 (skills) will consume.
Output: `knowledge/figma-api-rest.md` and `knowledge/figma-api-variables.md`
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/1-foundation/01-01-SUMMARY.md
@knowledge/README.md

# Source material (mine for content, correct inaccuracies):
@archive/agent-rewritten-01.md
@archive/initial-agent-audit.md

# Verify against current Figma developer documentation:
# - https://developers.figma.com/docs/rest-api/authentication/
# - https://developers.figma.com/docs/rest-api/file-endpoints/
# - https://developers.figma.com/docs/rest-api/variables-endpoints/
# - https://developers.figma.com/docs/rest-api/component-endpoints/

**Module structure convention (from knowledge/README.md):**
1. Title — Clear module name
2. Purpose — What knowledge this module contains
3. When to Use — Scenarios where this module should be @referenced
4. Content — The knowledge itself (rules, mappings, patterns, examples)
5. Cross-References — Related modules to consult for full context

**Key corrections from audit (initial-agent-audit.md):**
- `/files/:file_key/components` and `/styles` return *published library assets* only, not all components
- Prefer `GET /v1/files/:key/images` over legacy `/v1/images/:file_key`
- Variables API requires Enterprise org full member access + specific scopes
- Rate limits and pagination are real constraints — document them

**Established patterns:**
- Knowledge module naming: `{domain}-{topic}.md`
- Self-contained, independently @referenceable
- Optimized for Claude Code consumption (context window efficiency)

**Constraining decisions:**
- Phase 1: Module structure is title → purpose → when-to-use → content → cross-references
- No code implementation — pure documentation
- No secrets or API keys in any file
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create figma-api-rest.md — REST API reference</name>
  <files>knowledge/figma-api-rest.md</files>
  <action>
Create the authoritative Figma REST API reference module. Use archive/agent-rewritten-01.md as starting material but verify and expand against current Figma developer docs.

**Must cover:**
1. Authentication — PATs, `X-Figma-Token` header, OAuth2 flow overview, token scopes (file_content:read, file_dev_resources:read, file_dev_resources:write, webhooks:write)
2. Core endpoints with correct paths and parameters:
   - `GET /v1/files/:file_key` — full document tree, `?geometry=paths` for vectors, `?plugin_data=shared` for plugin data
   - `GET /v1/files/:file_key/nodes?ids=X:Y,A:B` — targeted node fetching (use this to limit payload)
   - `GET /v1/files/:file_key/images?ids=X:Y&format=svg|png|jpg|pdf&scale=N` — image/SVG export (NOT legacy /v1/images/)
   - `GET /v1/files/:file_key/components` — published library components ONLY (clarify this limitation)
   - `GET /v1/files/:file_key/component_sets` — published component sets ONLY
   - `GET /v1/files/:file_key/styles` — published styles ONLY
3. Node tree structure — Document, Canvas, Frame, Group, Component, Instance, Text, Vector, etc. Key properties: `type`, `name`, `id`, `children`, `absoluteBoundingBox`, `absoluteRenderBounds`
4. Pagination — cursor-based where applicable, response size management
5. Rate limits — document actual rate limiting behavior, backoff strategies, caching recommendations
6. File key and node ID parsing from Figma URLs (regex patterns)
7. Common pitfalls:
   - `/components` and `/styles` only return published library content
   - Full file fetch can be enormous — always use `/nodes` for targeted access
   - Node IDs use colon format `1:2` but URL-encoded as `1%3A2`
   - `absoluteBoundingBox` vs `absoluteRenderBounds` (render bounds account for strokes/shadows)

**Format:** Follow module structure convention. Use TypeScript interfaces for response shapes where helpful. Include practical examples with `curl` and TypeScript `fetch` patterns using `process.env.FIGMA_TOKEN`.

**Do NOT:** Include real API keys, invent endpoints that don't exist, or copy inaccuracies from the original spec.
  </action>
  <verify>
    - File exists at knowledge/figma-api-rest.md
    - Contains all 5 sections (title, purpose, when-to-use, content, cross-references)
    - Documents authentication, file endpoints, node endpoints, image endpoints, component endpoints, styles endpoints
    - Clarifies /components and /styles are published-only (audit correction)
    - Uses /v1/files/:key/images not legacy endpoint (audit correction)
    - No real API keys or secrets
    - Cross-references other Phase 2 modules
  </verify>
  <done>figma-api-rest.md exists with complete REST API reference covering auth, all major endpoints, node structure, rate limits, and common pitfalls. All audit corrections applied.</done>
</task>

<task type="auto">
  <name>Task 2: Create figma-api-variables.md — Variables API reference</name>
  <files>knowledge/figma-api-variables.md</files>
  <action>
Create the authoritative Figma Variables API reference module. This is the design tokens foundation that Phase 4 will build on.

**Must cover:**
1. Access requirements — Enterprise org full member access, required scopes
2. Core endpoints:
   - `GET /v1/files/:file_key/variables/local` — all local variables
   - `GET /v1/files/:file_key/variables/published` — published variables (for consumers)
   - `POST /v1/files/:file_key/variables` — create/update variables (write access)
3. Variable data model:
   - Variable: id, name, key, variableCollectionId, resolvedType (COLOR, FLOAT, STRING, BOOLEAN), valuesByMode, description, hiddenFromPublishing, scopes
   - VariableCollection: id, name, key, modes (id + name pairs), defaultModeId, variableIds
   - Variable scopes: ALL_SCOPES, TEXT_CONTENT, CORNER_RADIUS, WIDTH_HEIGHT, GAP, ALL_FILLS, FRAME_FILL, SHAPE_FILL, TEXT_FILL, STROKE_COLOR, EFFECT_COLOR, OPACITY, FONT_FAMILY, FONT_STYLE, FONT_SIZE, LINE_HEIGHT, LETTER_SPACING, FONT_WEIGHT, PARAGRAPH_SPACING, PARAGRAPH_INDENT
4. Variable resolution:
   - Direct values vs aliases (variable references)
   - Mode resolution (valuesByMode maps mode ID → value)
   - Fallback chains (what happens when a mode doesn't have a value)
   - Resolving bound variables on nodes: `boundVariables` property on any node
5. Multi-mode theming:
   - Light/dark mode pattern
   - Brand theming pattern
   - How modes map to CSS (CSS custom properties per mode, media queries, class-based switching)
6. Practical patterns:
   - Extracting all color tokens from a file
   - Building a token dictionary from variables
   - Detecting which variables are actually used (via boundVariables on nodes)
   - Platform-agnostic token export strategies

**Format:** Follow module structure convention. Include TypeScript interfaces for Variable, VariableCollection. Practical examples showing extraction patterns.

**Do NOT:** Fabricate API response shapes. If uncertain about a field, note it needs verification rather than guessing.
  </action>
  <verify>
    - File exists at knowledge/figma-api-variables.md
    - Contains all 5 sections (title, purpose, when-to-use, content, cross-references)
    - Documents access requirements (Enterprise org full members)
    - Covers variable data model (Variable, VariableCollection, scopes)
    - Explains variable resolution (direct values, aliases, modes, fallbacks)
    - Includes practical extraction patterns
    - No real API keys or secrets
    - Cross-references figma-api-rest.md and future design-tokens.md
  </verify>
  <done>figma-api-variables.md exists with complete Variables API reference covering access, endpoints, data model, resolution, multi-mode theming, and practical extraction patterns.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Both files exist in knowledge/ directory
- [ ] Both follow the module structure convention (title, purpose, when-to-use, content, cross-references)
- [ ] REST module covers: auth, file/node/image/component/style endpoints, node structure, rate limits, pitfalls
- [ ] Variables module covers: access requirements, endpoints, data model, resolution, modes, practical patterns
- [ ] All audit corrections from initial-agent-audit.md applied
- [ ] No real secrets or API keys in any file
- [ ] Cross-references between modules are accurate
</verification>

<success_criteria>

- Both knowledge modules created and follow conventions
- REST API reference is accurate (audit corrections applied)
- Variables API reference covers the full data model and resolution mechanics
- Content is optimized for Claude Code @reference consumption
- No errors, no fabricated endpoints, no secrets
</success_criteria>

<output>
After completion, create `.planning/phases/2-figma-api/02-01-SUMMARY.md`
</output>
