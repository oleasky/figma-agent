---
phase: 6-plugin-dev
plan: 02
type: execute
---

<objective>
Create plugin best practices knowledge module documenting production patterns from the reference plugin, then perform cross-module verification and update CLAUDE.md.

Purpose: Captures the hard-won production lessons from the reference plugin — error handling, performance, memory, caching, async patterns, and testing — that make the difference between a demo plugin and a production plugin. Then verifies all Phase 6 modules are consistent and cross-referenced.
Output: `knowledge/plugin-best-practices.md`, updated `CLAUDE.md`, cross-verified modules
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 6 Plan 1 output:
@.planning/phases/6-plugin-dev/06-01-SUMMARY.md
@knowledge/plugin-architecture.md
@knowledge/plugin-codegen.md

# Direct dependencies:
@.planning/phases/2-figma-api/02-02-SUMMARY.md

# Existing API reference modules:
@knowledge/figma-api-plugin.md
@knowledge/figma-api-devmode.md

# Source codebase:
# Reference plugin source codebase
# Key patterns: error handling (emitError), progress tracking (ExtractionStats), variable caching, token promotion, asset dedup, code validation

**Tech stack available:** @create-figma-plugin, Preact, TypeScript
**Established patterns:** Plugin sandbox, IPC, codegen lifecycle, data flow pipeline
**Constraining decisions:**
- Phase 2: Plugin sandbox model, IPC correlation IDs
- Phase 6 Plan 1: Architecture patterns, codegen patterns established
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plugin-best-practices.md knowledge module</name>
  <files>knowledge/plugin-best-practices.md</files>
  <action>
Create comprehensive best practices knowledge module documenting production-hardened patterns from the reference plugin. Structure with standard module format.

Content sections to include:

1. **Error Handling Patterns** — production error management:
   - Structured error types (ErrorData with code, message, details)
   - Error code enums (EXTRACTION_FAILED, GENERATION_FAILED, EXPORT_FAILED, etc.)
   - Error propagation across IPC boundary (emitError helper)
   - UI error display and recovery
   - Try/catch placement (wrap each event handler, NOT individual operations)
   - Graceful degradation (skip unsupported node types, continue extraction)

2. **Performance Patterns** — keeping plugins responsive:
   - Progress tracking for long operations (ExtractionStats with timing)
   - Depth limits on recursive traversal (maxDepth option)
   - Lazy node loading with `figma.getNodeByIdAsync()` + `dynamic-page` document access
   - Batch operations (process children in sequence, not parallel Promise.all on Figma API)
   - UI responsiveness during extraction (progress callbacks to UI thread)
   - Bundle size optimization (Preact over React, tree shaking, code splitting)

3. **Memory Management** — avoiding plugin crashes:
   - JSON-serializable intermediate format (can't pass Figma nodes across IPC)
   - Selective property extraction (only extract what generation needs)
   - Asset deduplication by filename/hash (don't export same image twice)
   - Large file handling (paginate or limit node count)
   - Clean up references (null out cached data when done)

4. **Caching Strategies** — reducing API calls and recomputation:
   - Variable cache pattern (lazy-load local variables once, reuse across nodes)
   - Font loading cache (check if font already loaded before loadFontAsync)
   - Component reference cache (map component IDs to names)
   - Cache invalidation on selection change
   - Session-scoped vs persistent caching (pluginData for persistence)

5. **Async Patterns** — working with Figma's async APIs:
   - `getNodeByIdAsync()` for dynamic-page plugins (NOT getNodeById)
   - `loadFontAsync()` before reading text node content
   - `exportAsync()` for image/SVG export
   - Sequential vs parallel async (sequential for Figma API, parallel OK for computation)
   - Timeout handling for long operations
   - Cancellation patterns (check if plugin still active)

6. **Testing & Debugging** — quality assurance:
   - Console logging strategy (prefixed, leveled)
   - Code validation (HTML structure, CSS syntax checking)
   - Mock data for UI development (test without Figma context)
   - Edge case handling (empty selections, text without fonts loaded, zero-size frames)
   - Common pitfalls checklist (accessing node after deletion, font not loaded, stale selection)

7. **Plugin Distribution** — preparing for release:
   - Manifest metadata (description, tags, icon)
   - Permission minimization (only request needed access)
   - Network access justification
   - Version management with @create-figma-plugin

Cross-reference plugin-architecture.md and plugin-codegen.md for patterns. Reference figma-api-plugin.md for API specifics. Focus on lessons learned and production patterns, not API documentation.

Target: ~800-1000 lines following established module conventions.
  </action>
  <verify>
- File exists at knowledge/plugin-best-practices.md
- Follows module structure: Purpose, When to Use, Content, Cross-References
- Contains error handling patterns with structured error types
- Contains performance patterns with progress tracking
- Contains caching strategies with variable cache example
- Contains async patterns (getNodeByIdAsync, loadFontAsync)
- Cross-references plugin-architecture.md, plugin-codegen.md, figma-api-plugin.md
- No real secrets or API keys
  </verify>
  <done>plugin-best-practices.md created with error handling, performance, memory, caching, async, testing, and distribution patterns — all sourced from production plugin experience</done>
</task>

<task type="auto">
  <name>Task 2: Cross-verify Phase 6 modules and update CLAUDE.md</name>
  <files>CLAUDE.md, knowledge/plugin-architecture.md, knowledge/plugin-codegen.md, knowledge/plugin-best-practices.md</files>
  <action>
Perform cross-module verification for all Phase 6 knowledge modules, then update CLAUDE.md.

**Cross-verification checks:**

1. Cross-references between Phase 6 modules are bidirectional and accurate:
   - plugin-architecture.md references plugin-codegen.md and plugin-best-practices.md
   - plugin-codegen.md references plugin-architecture.md and plugin-best-practices.md
   - plugin-best-practices.md references both other Phase 6 modules

2. Cross-references to Phase 2 API modules are accurate:
   - All three Phase 6 modules reference figma-api-plugin.md appropriately
   - plugin-codegen.md references figma-api-devmode.md
   - No content duplication between Phase 2 (API reference) and Phase 6 (development patterns)

3. Cross-references to Phase 3 design-to-code modules:
   - plugin-codegen.md references relevant design-to-code modules for generation patterns

4. Terminology consistency across all modules

**CLAUDE.md update:**
- Remove "(coming)" from the three Phase 6 module descriptions in the Knowledge Modules table
- Verify the module descriptions match actual content
- Ensure the table stays alphabetically/logically ordered

Fix any issues found during verification directly in the affected files.
  </action>
  <verify>
- All cross-references between Phase 6 modules are bidirectional
- No content duplication with Phase 2 API reference modules
- CLAUDE.md updated with Phase 6 modules (no "(coming)" markers)
- All module cross-reference paths are correct
  </verify>
  <done>All Phase 6 modules cross-verified, CLAUDE.md updated to reflect Phase 6 completion, all cross-references validated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] plugin-best-practices.md exists with production patterns from the reference plugin
- [ ] All three Phase 6 modules cross-reference each other
- [ ] No duplication with Phase 2 API reference modules
- [ ] CLAUDE.md updated (Phase 6 modules no longer marked "coming")
- [ ] All cross-references valid and bidirectional
- [ ] No real secrets or API keys
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Phase 6 fully complete (3 knowledge modules)
- CLAUDE.md reflects all Phase 6 modules
- Ready for Phase 7 (Skills & Installation)
</success_criteria>

<output>
After completion, create `.planning/phases/6-plugin-dev/06-02-SUMMARY.md`

Update `.planning/STATE.md`:
- Phase 6 status: complete (2/2)
- Next Action: Plan Phase 7 (Claude Skills & Installation)
</output>
