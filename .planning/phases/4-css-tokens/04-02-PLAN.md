---
phase: 04-css-tokens
plan: 02
type: execute
---

<objective>
Create the Figma Variables deep-dive knowledge module for design tokens, then cross-verify all Phase 4 modules and update CLAUDE.md.

Purpose: Complete the CSS/tokens knowledge suite with the Variables-specific token patterns, ensure consistency across all 3 new modules and existing modules, and update the project index.
Output: `knowledge/design-tokens-variables.md` (~800-1000 lines), verified cross-references, updated CLAUDE.md
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/4-css-tokens/04-01-SUMMARY.md

# Existing knowledge modules this plan must integrate with:
@knowledge/figma-api-variables.md
@knowledge/design-to-code-visual.md
@knowledge/design-to-code-layout.md
@knowledge/design-to-code-typography.md
@knowledge/css-strategy.md
@knowledge/design-tokens.md

**Established patterns:**
- Knowledge module structure: title → purpose → when-to-use → content sections → cross-references
- Bidirectional cross-references required between all sibling modules
- CLAUDE.md kept in sync with module completion status

**Constraining decisions:**
- [Phase 2]: Variables API requires Enterprise org full member access
- [Phase 2]: Token extraction priority: Variables API > published styles > file traversal > Plugin API
- [Phase 2]: Variable binding resolution: explicit variable → bound variable → token lookup → raw value
- [Phase 3]: 4-step color resolution chain documented in visual module
- [Phase 3]: Variable-aware gap/padding in layout module

**Source codebases for knowledge extraction:**

Reference plugin Variables-for-tokens (`src/tokens/`):
- `variables.ts` — Figma variable collection, mode extraction, alias resolution, local vs external handling
- `modes.ts` — Breakpoint mode detection (mobile/tablet/desktop, pixel values), theme mode (light/dark), mobile-first sorting
- `render.ts` — Mode-aware `:root` rendering with media queries and theme selectors
- `lookup.ts` — Variable binding priority over auto-detected tokens

Reference plugin extraction (`src/extraction/`):
- Variable binding extraction from node properties (fills, strokes, spacing, sizing)

Figma API reference:
- `knowledge/figma-api-variables.md` — API-level documentation (collections, modes, resolution, scopes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Design Tokens Variables knowledge module</name>
  <files>knowledge/design-tokens-variables.md</files>
  <action>
Create the Figma Variables deep-dive module focused specifically on how Figma Variables integrate with the design token system. This bridges figma-api-variables.md (API-level) and design-tokens.md (extraction pipeline).

**Structure the module with these sections:**

1. **Purpose & When to Use** — When working with Figma files that use Variables for design tokens. When handling multi-mode designs (responsive breakpoints, themes). When resolving variable bindings to CSS custom properties.
2. **Variables as Token Source** — Why Variables API is the highest-priority token source. Structured data vs heuristic extraction. Collection → token category mapping. When Variables API isn't available (non-Enterprise) → fallback to styles/traversal.
3. **Collection Structure for Tokens** — How Figma collections map to token categories: color collections → color tokens, spacing collections → spacing tokens. Collection naming conventions. Figma's collection organization patterns. From the reference plugin's `variables.ts`.
4. **Mode Detection & Classification** — Breakpoint modes: detecting "mobile", "tablet", "desktop" or pixel-value patterns. Theme modes: detecting "light", "dark" patterns. From the reference plugin's `modes.ts`. Sort order: mobile-first for breakpoints. Default mode identification (smallest breakpoint = base, light = default).
5. **Variable Resolution Chain** — Complete resolution from Figma variable to CSS output: bound variable reference → resolve aliases → extract per-mode values → generate CSS custom property. Alias chains (variable referencing another variable). Terminal value types (COLOR, FLOAT, STRING, BOOLEAN).
6. **Bound Variable Extraction** — How to extract variable bindings from node properties. Fill variables, stroke variables, effect variables. Layout variables (gap, padding, sizing). Text variables. From the reference plugin's extraction patterns. Priority: explicit binding > auto-detected token.
7. **CSS Custom Property Generation from Variables** — Variable path → CSS name conversion: `spacing/md` → `--spacing-md`, `color/primary/500` → `--color-primary-500`. Handling slash-delimited paths. Handling collection prefixes (include or strip). From the reference plugin's render patterns.
8. **Mode-Aware CSS Rendering** — Breakpoint modes → media queries: mobile = `:root {}`, tablet = `@media (min-width: 768px) { :root {} }`, desktop = `@media (min-width: 1024px) { :root {} }`. Theme modes → selectors: light = `:root {}`, dark = `@media (prefers-color-scheme: dark) { :root {} }` and `[data-theme="dark"] {}`. Dual selector pattern for dark mode (media query + data attribute). From the reference plugin's `modes.ts` + `render.ts`.
9. **Fallback Values** — When to include fallbacks: external library variables always get fallbacks. Local variables: optional fallback for resilience. Pattern: `var(--color-link, #DF10F6)`. Fallback extraction: use the resolved value from the default mode.
10. **Variable Scopes & Token Applicability** — Figma variable scopes (ALL_SCOPES, TEXT_CONTENT, CORNER_RADIUS, etc.) and how they constrain which CSS properties the token applies to. Scope → CSS property mapping.
11. **Multi-Mode Design Patterns** — Responsive tokens: same variable, different values per breakpoint. Theme tokens: same variable, different colors per theme. Combined: responsive + theme modes (cross-product). Practical patterns from the reference plugin: how spacing changes across breakpoints, how colors change across themes.
12. **Integration with Token Pipeline** — Where Variables fit in the extraction pipeline: Variables are collected alongside heuristic tokens, but always promoted (skip threshold). How variable tokens and auto-detected tokens coexist. Conflict resolution: variable wins. From the reference plugin's `promote.ts` + `lookup.ts`.
13. **Cross-References** — Bidirectional links to figma-api-variables.md, design-tokens.md, css-strategy.md, design-to-code-visual.md (variable bindings on visual properties), design-to-code-layout.md (variable bindings on layout spacing).

**Source from:** The reference plugin's `src/tokens/variables.ts`, `src/tokens/modes.ts`, `src/tokens/render.ts`. Figma API Variables module for API-level details (don't duplicate, reference).

**What to avoid and WHY:**
- Don't duplicate the Variables API reference (that's figma-api-variables.md) — reference it for API endpoints, collection/mode CRUD, authentication requirements
- Don't duplicate the general token extraction pipeline (that's design-tokens.md) — reference it for threshold promotion, naming conventions, token types
- Don't duplicate the CSS layer architecture (that's css-strategy.md) — reference it for where tokens go in the output
- Focus specifically on the Variables → Token → CSS bridge that neither of those modules covers in depth
  </action>
  <verify>
- File exists at knowledge/design-tokens-variables.md
- Contains all 13 sections listed above
- Mode detection logic clearly documented (breakpoint and theme patterns)
- Variable → CSS custom property naming conversion documented with examples
- Fallback value strategy documented
- Cross-references present to figma-api-variables.md, design-tokens.md, css-strategy.md, design-to-code modules
- No duplication of Variables API reference (api-level details reference figma-api-variables.md)
- Follows established module structure
  </verify>
  <done>
- design-tokens-variables.md created with complete Variables → token → CSS bridge
- Mode detection and classification documented
- Variable resolution chain documented from binding to CSS output
- Integration with token pipeline clearly shows how Variables and heuristic tokens coexist
- All cross-references present
  </done>
</task>

<task type="auto">
  <name>Task 2: Cross-verify Phase 4 modules and update CLAUDE.md</name>
  <files>knowledge/css-strategy.md, knowledge/design-tokens.md, knowledge/design-tokens-variables.md, knowledge/design-to-code-visual.md, knowledge/design-to-code-layout.md, knowledge/design-to-code-typography.md, knowledge/design-to-code-assets.md, knowledge/design-to-code-semantic.md, knowledge/figma-api-variables.md, CLAUDE.md</files>
  <action>
**Cross-verification (same pattern as Phase 3 03-04):**

1. Verify bidirectional cross-references between all 3 new Phase 4 modules (css-strategy ↔ design-tokens ↔ design-tokens-variables). Each must reference the other two.

2. Verify all design-to-code modules have their planned cross-references to Phase 4 modules updated from "_(planned)_" to actual references:
   - design-to-code-visual.md: references to css-strategy.md and design-tokens.md
   - design-to-code-layout.md: reference to css-strategy.md
   - design-to-code-typography.md: reference to css-strategy.md and design-tokens.md
   - design-to-code-assets.md: reference to css-strategy.md
   - design-to-code-semantic.md: references to css-strategy.md and design-tokens.md

3. Verify figma-api-variables.md cross-references to design-tokens.md, design-tokens-variables.md, css-strategy.md are updated from planned to actual.

4. Verify figma-api-webhooks.md reference to design-tokens.md is updated.

5. Update CLAUDE.md knowledge module table:
   - css-strategy.md: remove "(coming)", add actual description
   - design-tokens.md: remove "(coming)", add actual description
   - design-tokens-variables.md: remove "(coming)", add actual description

**Fix any missing or broken cross-references found.**

**What to avoid and WHY:**
- Don't modify content/substance of existing modules — only update cross-reference sections and "(planned)" markers
- Don't add new sections to existing modules — only fix references
  </action>
  <verify>
- All 3 Phase 4 modules cross-reference each other bidirectionally
- All design-to-code modules have "(planned)" removed from Phase 4 cross-references
- figma-api-variables.md cross-references updated
- CLAUDE.md table updated (no "(coming)" for Phase 4 modules)
- No broken or orphaned cross-references
  </verify>
  <done>
- Bidirectional cross-references verified across all 3 Phase 4 modules
- All "(planned)" markers updated to actual in existing modules
- CLAUDE.md reflects Phase 4 completion
- Phase 4 complete
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `knowledge/design-tokens-variables.md` exists with all 13 sections
- [ ] All 3 Phase 4 modules cross-reference each other
- [ ] All design-to-code module cross-references updated (no more "_(planned)_" for Phase 4 refs)
- [ ] figma-api-variables.md and figma-api-webhooks.md cross-references updated
- [ ] CLAUDE.md table updated for all 3 Phase 4 modules
- [ ] Token naming conventions consistent across design-tokens.md and design-tokens-variables.md
- [ ] No duplication between the three Phase 4 modules (each has distinct scope)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Variables → token → CSS bridge is clear and non-overlapping with figma-api-variables.md scope
- Cross-references verified across entire knowledge base (Phase 2 + 3 + 4)
- CLAUDE.md reflects Phase 4 completion
- Phase 4 complete, ready for Phase 5
  </success_criteria>

<output>
After completion, create `.planning/phases/4-css-tokens/04-02-SUMMARY.md`
</output>
