---
phase: 04-css-tokens
plan: 01
type: execute
---

<objective>
Create the CSS Strategy knowledge module and the Design Tokens knowledge module — documenting the production plugin's layered CSS architecture and threshold-based token extraction system.

Purpose: These two modules are the bridge between Figma design extraction (Phase 3) and production CSS output. Every design-to-code module references these as planned cross-references.
Output: `knowledge/css-strategy.md` (~800-1000 lines) and `knowledge/design-tokens.md` (~800-1000 lines)
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (dependency graph):
@.planning/phases/3-design-to-code/03-02-SUMMARY.md
@.planning/phases/3-design-to-code/03-04-SUMMARY.md

# Existing knowledge modules this plan must integrate with:
@knowledge/design-to-code-semantic.md
@knowledge/design-to-code-visual.md
@knowledge/design-to-code-typography.md
@knowledge/design-to-code-layout.md
@knowledge/design-to-code-assets.md
@knowledge/figma-api-variables.md

**Established patterns:**
- Knowledge module structure: title → purpose → when-to-use → content sections → cross-references
- Three-layer CSS: Tailwind (layout bones) + CSS Custom Properties (tokens) + CSS Modules (visual skin)
- HSL-based semantic color naming from visual module
- Token lookup system (value → CSS var) from visual + typography modules
- BEM flat hierarchy naming from semantic module

**Constraining decisions:**
- [Phase 3]: Three-layer CSS architecture decided and documented in semantic module (lines 839-920)
- [Phase 3]: HSL-based color token naming with hue range classification
- [Phase 3]: Token lookup pattern: `lookupColor(lookup, value)` → `var(--color-primary)`
- [Phase 2]: Token extraction priority: Variables API > published styles > file traversal > Plugin API
- [Phase 2]: Variables API requires Enterprise org full member access

**Source codebases for knowledge extraction:**

Reference plugin token system (`src/tokens/`):
- `promote.ts` — `collectAllTokens(node)`, `promoteTokens(tokens, threshold)`, default threshold = 2
- `colors.ts` — HSL semantic naming, hue/saturation classification (primary, accent, success, warning, error)
- `spacing.ts` — Base unit detection (4px/8px), scale naming (--spacing-1, --spacing-2)
- `typography.ts` — Font family, size, weight tokens
- `effects.ts` — Shadow size scale (sm/md/lg), radius tokens
- `variables.ts` — Figma variable collection, mode extraction (breakpoint/theme)
- `modes.ts` — Breakpoint mode (mobile-first), theme mode (light/dark, prefers-color-scheme)
- `lookup.ts` — `TokenLookup` interface, `buildTokenLookup()`, type-specific lookups
- `render.ts` — `:root` CSS generation with mode-aware media queries
- `render-scss.ts` — SCSS `$variable` generation
- `types.ts` — Token type definitions

Reference plugin CSS generation (`src/generation/`):
- `render.ts` — Orchestrates layout → HTML/CSS, token substitution in generated styles
- `layout.ts` — Figma variable priority over auto-detected tokens for spacing
- `visual.ts` — Color token substitution via `lookupFillColor(fill, lookup)`

Reference plugin export (`src/export/`):
- `css.ts` — Separate files: reset.css, tokens.css, styles.css (or merged)
- `scss.ts` — SCSS export with `$variable` conversion

Reference PayloadCMS project token system:
- `src/styles/tokens.css` — `:root` with `--token-*` naming: colors, spacing (8pt scale), typography, radii, shadows, transitions
- `src/styles/blocks/*.module.css` — 14 block CSS Modules using `var(--token-*, fallback)` pattern
- `packages/payload-visual-builder/src/styles/visualCanvas.module.css` — Token aliasing (`--vb-*` → `--token-*`) + CSS containment isolation
- `postcss.config.mjs` — Tailwind v4 via `@tailwindcss/postcss`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSS Strategy knowledge module</name>
  <files>knowledge/css-strategy.md</files>
  <action>
Create the CSS strategy knowledge module documenting the layered CSS architecture from the production plugin and reference project patterns.

**Structure the module with these sections:**

1. **Purpose & When to Use** — When generating CSS from Figma designs, choosing which CSS layer for each property
2. **Three-Layer Architecture Overview** — Tailwind (structural layout at zero specificity), CSS Custom Properties (design tokens bridge), CSS Modules (visual design skin, component-scoped)
3. **Layer 1: Tailwind CSS (Layout Bones)** — Which properties go here (display, flex, gap, padding structural, sizing, responsive breakpoints). Utility class mapping from Figma Auto Layout. When NOT to use Tailwind (visual design properties like colors, shadows). Integration with CSS custom properties via Tailwind config.
4. **Layer 2: CSS Custom Properties (Design Tokens)** — Token placement at `:root`. Category naming conventions (--color-*, --spacing-*, --text-*, --font-*, --shadow-*, --radius-*, --transition-*). Mode-aware tokens (breakpoint media queries, theme selectors). The `--token-*` prefix pattern. Token fallback pattern: `var(--token-color-primary, #3b82f6)`.
5. **Layer 3: CSS Modules (Visual Skin)** — Component-scoped styles. BEM naming within modules. Token consumption pattern. File organization (per-block modules). Centralized export pattern (index.ts barrel). Visual Builder token aliasing (`--vb-*` → `--token-*`) for plugin isolation.
6. **Property Placement Decision Tree** — For any CSS property generated from Figma, which layer does it go to? Layout → Tailwind. Token value → Custom Property. Component-specific visual → CSS Module. Expanded from semantic module's table (lines 843-851).
7. **Specificity Management** — Zero specificity for tokens (:root). Low specificity for Tailwind utilities. Scoped specificity for CSS Modules. How layers compose without conflicts.
8. **Responsive Strategy** — Mobile-first breakpoint ordering. Figma Variables mode → media query mapping. Tailwind responsive prefixes (sm:, md:, lg:). CSS Module responsive patterns.
9. **Theme Support** — Light/dark theme via CSS custom properties. `prefers-color-scheme` media query. `[data-theme]` selector. Figma Variables theme mode mapping.
10. **Export Formats** — Separate files (reset.css, tokens.css, styles.css) vs merged output. SCSS export option ($variables). File organization conventions.
11. **Integration with Design-to-Code Pipeline** — How layout.md, visual.md, typography.md, assets.md, semantic.md feed into the CSS strategy. Token lookup during generation. Practical examples showing all three layers working together.
12. **Cross-References** — Bidirectional links to all 5 design-to-code modules, design-tokens.md, design-tokens-variables.md, figma-api-variables.md.

**Source from:** The reference plugin's export/css.ts and generation/*.ts for the layered strategy. The reference project's tokens.css + CSS Modules for production token consumption. Semantic module's three-layer section (lines 839-920) as the foundation to expand.

**What to avoid and WHY:**
- Don't duplicate the token extraction logic (that's design-tokens.md's job) — reference it
- Don't duplicate variable resolution (that's design-tokens-variables.md's job) — reference it
- Don't re-document Figma properties (that's design-to-code modules' job) — show how their output flows into CSS layers
- Don't write actual code implementations — document the patterns and decision rules
  </action>
  <verify>
- File exists at knowledge/css-strategy.md
- Contains all 12 sections listed above
- Cross-references to design-to-code modules, design-tokens.md, design-tokens-variables.md are present
- Property placement decision tree is actionable (for any Figma property, reader can determine which CSS layer)
- Follows established module structure: title → purpose → when-to-use → content → cross-refs
  </verify>
  <done>
- css-strategy.md created with layered CSS architecture fully documented
- Property placement decision tree covers all Figma property types
- Both production plugin and reference project patterns represented
- All cross-references present (bidirectional links to design-to-code modules + planned token modules)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Design Tokens knowledge module</name>
  <files>knowledge/design-tokens.md</files>
  <action>
Create the design tokens knowledge module documenting the production plugin's token extraction, promotion, naming, and rendering system.

**Structure the module with these sections:**

1. **Purpose & When to Use** — When extracting design tokens from Figma files for CSS variable generation. When configuring Tailwind theme from Figma tokens.
2. **Token Extraction Pipeline** — Overview: Extract from Figma nodes → Collect tokens → Promote (threshold) → Name (semantic) → Render (CSS/SCSS). The `collectAllTokens(node)` recursive collection pattern.
3. **Token Types** — Color tokens (from fills, strokes, effects), Spacing tokens (from gap, padding), Typography tokens (font family, size, weight), Effect tokens (shadows, radii). Each with extraction source, naming convention, and examples.
4. **Color Token Extraction** — HSL-based semantic naming: hue ranges → primary/secondary/accent/neutral/success/warning/error. Neutral scale by lightness (100-900). Normalizing hex and rgba. Deduplication. From the reference plugin's `colors.ts`.
5. **Spacing Token Extraction** — Base unit detection (GCD of spacing values, typically 4px or 8px). Scale naming (--spacing-1 through --spacing-N). Context tracking (gap vs padding vs margin). Example 8-point scale: xs(4px), sm(8px), md(16px), lg(24px), xl(32px), 2xl(48px), 3xl(64px). From the reference plugin's `spacing.ts`.
6. **Typography Token Extraction** — Font family tokens (--font-primary, --font-mono). Size tokens (--text-sm/md/lg/xl or named scale). Weight tokens. Line height tokens. From the reference plugin's `typography.ts`.
7. **Effect Token Extraction** — Shadow tokens by size scale (--shadow-sm/md/lg). Radius tokens (--radius-sm/md/lg/full). Transition tokens (--transition-fast/normal/slow). From the reference plugin's `effects.ts`.
8. **Threshold-Based Promotion** — `promoteTokens(tokens, threshold)`. Default threshold = 2. Single-use values stay inline. Repeated values become CSS variables. Figma Variables always promoted (explicit bindings override threshold). Rationale: prevents token bloat.
9. **Token Naming Conventions** — Category prefix pattern: `--color-*`, `--spacing-*`, `--text-*`, `--font-*`, `--shadow-*`, `--radius-*`. The `--token-*` double-prefix pattern. Figma variable path conversion: `spacing/md` → `--spacing-md`. Conflict resolution when auto-detected and Figma variable tokens overlap.
10. **Token Lookup System** — `TokenLookup` interface. `buildTokenLookup(tokens)` creates reverse maps. Type-specific lookups: `lookupColor()`, `lookupSpacing()`, `lookupRadius()`. Figma variable bindings override auto-detected tokens. Integration with generation pipeline.
11. **CSS Rendering** — `:root` block generation. Category grouping with comments. Mode-aware rendering (breakpoint media queries, theme selectors). Fallback values for external library variables: `var(--color-link, #DF10F6)`. From the reference plugin's `render.ts`.
12. **SCSS Rendering** — `$variable` conversion from CSS custom properties. SCSS file organization (_variables.scss, _reset.scss, styles.scss). From the reference plugin's `render-scss.ts`.
13. **Tailwind Config Generation** — Mapping token categories to Tailwind theme config: colors → theme.colors, spacing → theme.spacing, fontSize → theme.fontSize, borderRadius → theme.borderRadius. CSS variable references in Tailwind config: `primary: 'var(--color-primary)'`.
14. **Cross-References** — Bidirectional links to css-strategy.md, design-tokens-variables.md, all design-to-code modules, figma-api-variables.md.

**Source from:** The reference plugin's `src/tokens/` directory (promote.ts, colors.ts, spacing.ts, typography.ts, effects.ts, lookup.ts, render.ts, render-scss.ts, types.ts). The reference project's `src/styles/tokens.css` for naming conventions.

**What to avoid and WHY:**
- Don't document Figma Variables API details (that's figma-api-variables.md) — reference it
- Don't document the CSS layer strategy (that's css-strategy.md) — reference it
- Don't duplicate visual property extraction rules (that's design-to-code-visual.md) — show how extracted values become tokens
- Don't include actual TypeScript implementations — document the patterns, algorithms, and decision rules
  </action>
  <verify>
- File exists at knowledge/design-tokens.md
- Contains all 14 sections listed above
- Threshold-based promotion logic clearly documented with examples
- Token naming conventions complete for all categories (color, spacing, typography, effects)
- Cross-references present to css-strategy.md, design-tokens-variables.md, figma-api-variables.md, design-to-code modules
- Follows established module structure
  </verify>
  <done>
- design-tokens.md created with complete token extraction pipeline
- All token types documented (color, spacing, typography, effects)
- Promotion threshold logic documented with rationale
- Naming conventions cover both production plugin and reference project patterns
- Tailwind config generation documented
- All cross-references present
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `knowledge/css-strategy.md` exists with all 12 sections
- [ ] `knowledge/design-tokens.md` exists with all 14 sections
- [ ] Both files follow established module structure (title → purpose → when-to-use → content → cross-refs)
- [ ] Property placement decision tree in css-strategy.md covers all Figma property types
- [ ] Token naming conventions are consistent between the two modules
- [ ] Cross-references are bidirectional between the two new modules
- [ ] Cross-references to existing design-to-code modules are present
- [ ] No duplication of content that belongs in design-tokens-variables.md (planned for 04-02)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Both modules encode production plugin + reference project patterns (not spec assumptions)
- Layered CSS strategy is actionable (for any Figma property → which CSS layer)
- Token extraction pipeline is reproducible (clear algorithm, not vague guidance)
- No content that belongs in design-tokens-variables.md duplicated here
  </success_criteria>

<output>
After completion, create `.planning/phases/4-css-tokens/04-01-SUMMARY.md`
</output>
